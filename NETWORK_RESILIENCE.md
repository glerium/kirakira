# 网络错误修复和弹性机制说明

## 问题背景

在之前的版本中，机器人存在以下问题：
- 网络错误时机器人离线，需要手动重启
- 没有自动重连机制
- API调用失败后不重试
- 缺少连接状态监控

## 解决方案

### 1. WebSocket自动重连机制

#### 功能特性
- **自动重连**：当WebSocket连接断开时，自动尝试重新连接
- **心跳检测**：定期检查连接状态，及时发现并修复连接问题
- **事件监听**：监听机器人上线/离线事件，实时更新连接状态
- **状态检查**：发送消息前检查连接状态，避免无效操作

#### 配置参数

在 `application.properties` 中可以配置以下参数：

```properties
# WebSocket 重连延迟（秒），默认 10
bot.websocket.reconnect.delay.seconds=10

# WebSocket 心跳检测间隔（秒），默认 60
bot.websocket.heartbeat.interval.seconds=60
```

#### 工作流程

1. **初始连接**：应用启动时自动连接到WebSocket服务器
2. **连接监控**：
   - 监听 `BotOfflineEvent` 事件，检测连接断开
   - 监听 `BotOnlineEvent` 事件，确认连接恢复
   - 定期执行心跳检测（默认每60秒）
3. **断线重连**：
   - 检测到连接断开后，等待10秒（可配置）
   - 自动尝试重新建立连接
   - 重新注册消息监听器
4. **发送保护**：
   - 发送消息前检查连接状态
   - 如果未连接，返回错误信息而不是崩溃

### 2. HTTP请求重试机制

#### 功能特性
- **自动重试**：网络异常时自动重试，最多3次（可配置）
- **递增延迟**：使用指数退避策略，避免频繁请求
- **异常分类**：区分不同类型错误，仅对可恢复错误重试
- **详细日志**：记录每次重试和失败原因

#### 配置参数

```properties
# Codeforces API 最大重试次数，默认 3
bot.codeforces.api.max.retries=3

# Codeforces API 重试延迟基数（毫秒），默认 2000
# 实际延迟为：基数 × 重试次数（线性退避：2秒、4秒、6秒）
bot.codeforces.api.retry.delay.ms=2000
```

#### 重试策略

1. **不重试的情况**：
   - 用户不存在（UserNotFoundException）
   - HTTP 4xx 客户端错误（如403、404）

2. **重试的情况**：
   - 网络连接超时（ResourceAccessException）
   - 其他临时性异常

3. **延迟策略（线性退避）**：
   - 第1次重试：等待 2 秒（基数 × 1）
   - 第2次重试：等待 4 秒（基数 × 2）
   - 第3次重试：等待 6 秒（基数 × 3）
   - 超过最大次数：抛出异常

### 3. 监控服务增强

#### 连接状态检查
- 在定时任务开始时检查机器人连接状态
- 如果未连接，跳过本次检查，避免无效操作
- 发送消息前再次检查连接状态

#### 错误隔离
- 为每个用户的处理添加异常捕获
- 单个用户的错误不影响其他用户的处理
- 所有错误都记录到日志并发送通知

#### 详细日志
- 记录连接状态变化
- 记录每次API调用和重试
- 记录所有异常和错误原因

## 使用建议

### 1. 日志监控

建议配置日志级别，关注以下日志：

```properties
# 查看详细的连接和重试信息
logging.level.com.kirakira.client=INFO
logging.level.com.kirakira.service.MonitorService=INFO
```

关键日志消息：
- `正在连接到WebSocket服务器` - 开始连接
- `成功连接到WebSocket服务器` - 连接成功
- `连接到WebSocket服务器失败` - 连接失败，将自动重试
- `机器人已离线` - 检测到离线
- `尝试重新连接到WebSocket服务器` - 开始重连
- `心跳检测发现连接已断开` - 心跳检测发现问题
- `Codeforces API请求失败, 重试 X/Y` - API重试中

### 2. 参数调优

根据实际网络环境调整参数：

#### 网络稳定环境
```properties
bot.websocket.reconnect.delay.seconds=10
bot.websocket.heartbeat.interval.seconds=60
bot.codeforces.api.max.retries=3
bot.codeforces.api.retry.delay.ms=2000
```

#### 网络不稳定环境
```properties
bot.websocket.reconnect.delay.seconds=15
bot.websocket.heartbeat.interval.seconds=30
bot.codeforces.api.max.retries=5
bot.codeforces.api.retry.delay.ms=3000
```

### 3. 监控告警

建议配置错误通知群组：

```properties
# 错误通知群组 ID
bot.error.notification.group.id=123456789
```

这样当发生错误时，会自动发送通知到指定群组。

## 故障排查

### 问题：频繁重连

**可能原因**：
1. NapCat服务不稳定
2. 网络质量差
3. WebSocket配置错误

**解决方法**：
1. 检查NapCat服务状态
2. 检查网络连接
3. 适当增加重连延迟和心跳间隔
4. 查看日志中的具体错误信息

### 问题：API调用失败

**可能原因**：
1. Codeforces API限流
2. 网络问题
3. 配置的用户不存在

**解决方法**：
1. 检查是否触发API限流（每秒5次）
2. 增加重试次数和延迟
3. 检查日志中的错误信息
4. 对于不存在的用户，会自动从数据库移除

### 问题：消息发送失败

**可能原因**：
1. 机器人未连接
2. 群组配置错误
3. 权限不足

**解决方法**：
1. 检查日志中的连接状态
2. 确认群组ID正确
3. 确认机器人在群组中且有发言权限

## 技术细节

### 线程安全
- 使用 `volatile` 关键字保证连接状态的可见性
- 使用 `synchronized` 关键字保证连接方法的线程安全
- 使用 `ScheduledExecutorService` 管理定时任务

### 资源管理
- 提供 `shutdown()` 方法正确关闭连接和线程池
- 自动清理失败的连接尝试

### 异常处理
- 区分不同类型的异常
- 对可恢复异常进行重试
- 对不可恢复异常记录日志并通知

## 升级说明

从旧版本升级时：

1. **配置文件**：新增配置项都有默认值，无需修改即可使用
2. **兼容性**：完全向后兼容，不会影响现有功能
3. **数据库**：无需修改数据库结构
4. **依赖**：无新增依赖

## 总结

这次更新显著提升了机器人的网络弹性和稳定性：

✅ 自动从网络故障中恢复，无需手动重启
✅ 智能重试机制，减少临时网络问题的影响
✅ 详细的日志记录，便于问题排查
✅ 灵活的配置选项，适应不同环境
✅ 完善的错误处理，提高系统鲁棒性

建议在生产环境部署后，持续观察日志，根据实际情况调整配置参数。
